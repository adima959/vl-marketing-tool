<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Campaign Debug Tool</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      padding: 20px;
      background: #f5f5f5;
      line-height: 1.6;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    h1 {
      color: #1a1a1a;
      margin-bottom: 24px;
      font-size: 28px;
      font-weight: 600;
    }
    .section {
      background: white;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .section h2 {
      color: #2c3e50;
      margin-bottom: 16px;
      font-size: 20px;
      font-weight: 600;
    }
    .button-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    button:hover {
      background: #2563eb;
    }
    button:active {
      transform: scale(0.98);
    }
    button.secondary {
      background: #6b7280;
    }
    button.secondary:hover {
      background: #4b5563;
    }
    .loading {
      display: none;
      color: #6b7280;
      font-size: 14px;
      margin: 12px 0;
    }
    .loading.active {
      display: block;
    }
    .result {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 16px;
      margin-top: 16px;
      overflow-x: auto;
      max-height: 600px;
      overflow-y: auto;
    }
    .result pre {
      margin: 0;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .highlight {
      background: #fef3c7;
      padding: 12px;
      border-left: 4px solid #f59e0b;
      border-radius: 4px;
      margin: 12px 0;
      font-size: 14px;
    }
    .highlight strong {
      color: #92400e;
    }
    .error {
      background: #fee2e2;
      border-left-color: #ef4444;
      color: #991b1b;
    }
    .success {
      background: #d1fae5;
      border-left-color: #10b981;
      color: #065f46;
    }
    .summary-box {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 6px;
      padding: 16px;
      margin: 12px 0;
    }
    .summary-box h3 {
      color: #1e40af;
      margin-bottom: 8px;
      font-size: 16px;
    }
    .summary-box .metric {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #dbeafe;
    }
    .summary-box .metric:last-child {
      border-bottom: none;
    }
    .summary-box .metric-label {
      color: #4b5563;
      font-size: 14px;
    }
    .summary-box .metric-value {
      color: #1e40af;
      font-weight: 600;
      font-size: 14px;
    }
    .instructions {
      background: #f0fdf4;
      border: 1px solid #86efac;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .instructions h3 {
      color: #166534;
      margin-bottom: 8px;
      font-size: 16px;
    }
    .instructions ol {
      margin-left: 20px;
      color: #166534;
      font-size: 14px;
    }
    .instructions li {
      margin: 6px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Campaign Debug Tool - Balansera_Dnk_IM_24_11</h1>

    <div class="instructions">
      <h3>üìã Instructions</h3>
      <ol>
        <li>Make sure you're logged into the dashboard (check that you can access /marketing-report)</li>
        <li>Click the buttons below to run debug queries</li>
        <li>Results will appear below each button</li>
        <li>Look for discrepancies between expected (3,571 clicks) and actual values</li>
      </ol>
    </div>

    <div class="highlight">
      <strong>Problem:</strong> Google Ads shows 3,571 clicks but dashboard shows 1,275 clicks for Feb 1, 2026
    </div>

    <!-- Step 1: Raw Campaign Data -->
    <div class="section">
      <h2>Step 1: Raw Database Data</h2>
      <p style="color: #6b7280; margin-bottom: 12px; font-size: 14px;">
        Queries the database directly to see what data is actually stored
      </p>
      <div class="button-group">
        <button onclick="runStep1()">‚ñ∂ Run Step 1: Check Raw Data</button>
        <button class="secondary" onclick="clearResult('result1')">Clear Results</button>
      </div>
      <div id="loading1" class="loading">Loading...</div>
      <div id="result1" class="result" style="display: none;"></div>
    </div>

    <!-- Step 2: Compare Aggregations -->
    <div class="section">
      <h2>Step 2: Compare Aggregation Methods</h2>
      <p style="color: #6b7280; margin-bottom: 12px; font-size: 14px;">
        Tests different aggregation methods to identify where data is lost
      </p>
      <div class="button-group">
        <button onclick="runStep2()">‚ñ∂ Run Step 2: Compare Aggregations</button>
        <button class="secondary" onclick="clearResult('result2')">Clear Results</button>
      </div>
      <div id="loading2" class="loading">Loading...</div>
      <div id="result2" class="result" style="display: none;"></div>
    </div>

    <!-- Step 3: Trace Dashboard Query -->
    <div class="section">
      <h2>Step 3: Trace Dashboard Query</h2>
      <p style="color: #6b7280; margin-bottom: 12px; font-size: 14px;">
        Traces the exact SQL queries executed by the dashboard
      </p>
      <div class="button-group">
        <button onclick="runStep3()">‚ñ∂ Run Step 3: Trace Query</button>
        <button class="secondary" onclick="clearResult('result3')">Clear Results</button>
      </div>
      <div id="loading3" class="loading">Loading...</div>
      <div id="result3" class="result" style="display: none;"></div>
    </div>

    <!-- Run All -->
    <div class="section">
      <h2>Quick Actions</h2>
      <div class="button-group">
        <button onclick="runAll()" style="background: #10b981;">‚ñ∂ Run All Tests</button>
        <button class="secondary" onclick="clearAll()">Clear All Results</button>
      </div>
    </div>
  </div>

  <script>
    function showLoading(id) {
      document.getElementById('loading' + id).classList.add('active');
    }

    function hideLoading(id) {
      document.getElementById('loading' + id).classList.remove('active');
    }

    function showResult(id, content) {
      const resultDiv = document.getElementById('result' + id);
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = content;
    }

    function clearResult(id) {
      document.getElementById(id).style.display = 'none';
      document.getElementById(id).innerHTML = '';
    }

    function clearAll() {
      clearResult('result1');
      clearResult('result2');
      clearResult('result3');
    }

    async function runStep1() {
      const stepNum = '1';
      showLoading(stepNum);

      try {
        const response = await fetch('/api/debug/raw-campaign-data?campaign=Balansera_Dnk_IM_24_11&start=2026-02-01&end=2026-02-01');
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Request failed');
        }

        // Build summary
        const summary = data.data.summary;
        let html = '<div class="summary-box">';
        html += '<h3>üìä Summary</h3>';
        html += `<div class="metric"><span class="metric-label">Total Clicks (Raw DB)</span><span class="metric-value">${summary?.total_clicks || 0}</span></div>`;
        html += `<div class="metric"><span class="metric-label">Expected (Google Ads)</span><span class="metric-value">3,571</span></div>`;
        html += `<div class="metric"><span class="metric-label">Discrepancy</span><span class="metric-value">${3571 - (summary?.total_clicks || 0)}</span></div>`;
        html += `<div class="metric"><span class="metric-label">Raw Rows</span><span class="metric-value">${summary?.row_count || 0}</span></div>`;
        html += '</div>';

        // Add analysis
        const clicks = summary?.total_clicks || 0;
        if (clicks === 3571) {
          html += '<div class="highlight success"><strong>‚úì Data is in database!</strong> The issue is in the aggregation logic.</div>';
        } else if (clicks === 1275) {
          html += '<div class="highlight error"><strong>‚úó Database has wrong data!</strong> The issue is with date/name filtering or sync.</div>';
        } else {
          html += '<div class="highlight error"><strong>‚úó Unexpected result!</strong> Need to investigate further.</div>';
        }

        html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
        showResult(stepNum, html);
      } catch (error) {
        showResult(stepNum, '<div class="highlight error"><strong>Error:</strong> ' + error.message + '</div>');
      } finally {
        hideLoading(stepNum);
      }
    }

    async function runStep2() {
      const stepNum = '2';
      showLoading(stepNum);

      try {
        const response = await fetch('/api/debug/compare-aggregations?campaign=Balansera_Dnk_IM_24_11&start=2026-02-01&end=2026-02-01');
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Request failed');
        }

        // Build summary
        const agg = data.data.aggregations;
        let html = '<div class="summary-box">';
        html += '<h3>üìä Aggregation Comparison</h3>';
        html += `<div class="metric"><span class="metric-label">Simple SUM</span><span class="metric-value">${agg.simpleSum?.total_clicks || 0}</span></div>`;
        html += `<div class="metric"><span class="metric-label">GROUP BY campaign_name</span><span class="metric-value">${agg.groupByCampaign?.total_clicks || 0}</span></div>`;
        html += `<div class="metric"><span class="metric-label">NULL clicks</span><span class="metric-value">${agg.nullCheck?.null_clicks || 0}</span></div>`;
        html += `<div class="metric"><span class="metric-label">Duplicates found</span><span class="metric-value">${agg.duplicateCheck?.duplicatesFound || 0}</span></div>`;
        html += '</div>';

        // Add analysis
        if (data.data.analysis?.possibleIssues && data.data.analysis.possibleIssues.length > 0) {
          html += '<div class="highlight error"><strong>üîç Possible Issues:</strong><ul>';
          data.data.analysis.possibleIssues.forEach(issue => {
            html += `<li>${issue}</li>`;
          });
          html += '</ul></div>';
        } else {
          html += '<div class="highlight success"><strong>‚úì No obvious issues found</strong> in aggregation logic.</div>';
        }

        html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
        showResult(stepNum, html);
      } catch (error) {
        showResult(stepNum, '<div class="highlight error"><strong>Error:</strong> ' + error.message + '</div>');
      } finally {
        hideLoading(stepNum);
      }
    }

    async function runStep3() {
      const stepNum = '3';
      showLoading(stepNum);

      try {
        const response = await fetch('/api/debug/marketing-query-trace', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            dateRange: { start: '2026-02-01', end: '2026-02-01' },
            dimensions: ['campaign'],
            depth: 0,
            parentFilters: {}
          })
        });
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Request failed');
        }

        // Build summary
        let html = '<div class="summary-box">';
        html += '<h3>üìä Query Trace Summary</h3>';
        html += `<div class="metric"><span class="metric-label">Ads Data Rows</span><span class="metric-value">${data.summary?.adsDataRowCount || 0}</span></div>`;
        html += `<div class="metric"><span class="metric-label">Campaign Found</span><span class="metric-value">${data.summary?.specificCampaignFound ? 'Yes' : 'No'}</span></div>`;
        html += '</div>';

        html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
        showResult(stepNum, html);
      } catch (error) {
        showResult(stepNum, '<div class="highlight error"><strong>Error:</strong> ' + error.message + '</div>');
      } finally {
        hideLoading(stepNum);
      }
    }

    async function runAll() {
      await runStep1();
      await new Promise(resolve => setTimeout(resolve, 500));
      await runStep2();
      await new Promise(resolve => setTimeout(resolve, 500));
      await runStep3();
    }
  </script>
</body>
</html>
