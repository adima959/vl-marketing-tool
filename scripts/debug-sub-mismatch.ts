/**
 * Debug: Compare CRM subscription IDs against our dashboard query.
 *
 * CRM reports 1104 subscriptions for Jan 9 â€“ Feb 9, 2026.
 * Dashboard shows 956. Find the difference.
 *
 * Run: npx tsx scripts/debug-sub-mismatch.ts
 */
import mysql from 'mysql2/promise';
import { config } from 'dotenv';

config({ path: '.env.local' });

const pool = mysql.createPool({
  host: process.env.MARIADB_HOST,
  port: parseInt(process.env.MARIADB_PORT || '3306'),
  user: process.env.MARIADB_USER,
  password: process.env.MARIADB_PASSWORD,
  database: process.env.MARIADB_DATABASE,
  connectTimeout: 30000,
  waitForConnections: true,
});

const S = '2026-01-09 00:00:00';
const E = '2026-02-09 23:59:59';

async function q<T>(sql: string, p: unknown[] = []): Promise<T[]> {
  const [rows] = await pool.execute(sql, p);
  return rows as T[];
}

// All 1104 subscription IDs from the CRM extract
const CRM_IDS = new Set([
  316251,316256,316261,316266,316270,316271,316294,316302,316304,316305,
  316320,316321,316322,316351,316352,316353,316360,316367,316381,316402,
  316403,316413,316423,316433,316435,316438,316439,316477,316478,316479,
  316480,316482,316483,316484,316497,316498,316499,316508,316510,316529,
  316531,316534,316535,316538,316539,316540,316542,316543,316544,316545,
  316552,316553,316554,316561,316562,316565,316566,316571,316575,316576,
  316596,316598,316602,316608,316609,316622,316623,316624,316653,316654,
  316655,316660,316670,316674,316679,316698,316707,316716,316717,316718,
  316719,316738,316739,316744,316745,316747,316748,316759,316761,316787,
  316793,316796,316797,316799,316814,316826,316828,316829,316846,316858,
  316863,316864,316867,316872,316876,316880,316887,316892,316902,316920,
  316927,316952,316955,316956,316954,316963,316966,316973,316976,316977,
  316984,316986,316988,316993,316994,316996,317024,317037,317039,317048,
  317049,317053,317066,317074,317096,317099,317104,317110,317119,317128,
  317131,317143,317149,317155,317163,317165,317167,317168,317193,317194,
  317200,317219,317221,317222,317227,317235,317241,317243,317246,317287,
  317291,317315,317321,317330,317331,317332,317334,317347,317348,317352,
  317370,317375,317376,317377,317390,317399,317408,317412,317431,317442,
  317443,317448,317449,317477,317495,317497,317502,317503,317505,317506,
  317507,317508,317517,317518,317520,317532,317533,317551,317594,317597,
  317598,317614,317616,317624,317625,317626,317654,317655,317656,317657,
  317658,317664,317667,317678,317686,317689,317702,317704,317707,317715,
  317719,317720,317722,317724,317726,317738,317740,317764,317779,317788,
  317802,317805,317806,317811,317813,317819,317830,317843,317845,317846,
  317870,317878,317883,317885,317888,317893,317912,317921,317926,317945,
  317950,317960,317978,317992,317997,318003,318005,318012,318015,318017,
  316249,316250,316253,316254,316255,316257,316258,316260,316262,316263,
  316265,316269,316272,316276,316277,316278,316279,316289,316293,316299,
  316300,316301,316307,316311,316312,316313,316318,316319,316323,316324,
  316325,316326,316327,316328,316329,316330,316332,316334,316335,316337,
  316338,316339,316340,316342,316349,316350,316357,316358,316361,316362,
  316364,316365,316366,316368,316373,316375,316376,316377,316379,316380,
  316382,316383,316385,316386,316387,316388,316389,316390,316391,316392,
  316394,316395,316396,316397,316398,316399,316400,316401,316406,316407,
  316408,316409,316410,316411,316412,316414,316415,316416,316417,316418,
  316419,316420,316421,316422,316425,316426,316427,316428,316429,316430,
  316431,316432,316434,316436,316437,316440,316441,316442,316443,316446,
  316451,316452,316453,316456,316458,316459,316460,316461,316462,316463,
  316464,316465,316466,316467,316468,316470,316471,316472,316473,316474,
  316475,316476,316481,316486,316487,316488,316489,316490,316491,316492,
  316493,316494,316496,316501,316502,316503,316504,316507,316513,316520,
  316521,316522,316523,316524,316525,316526,316527,316528,316530,316533,
  316536,316537,316541,316546,316547,316548,316549,316551,316556,316557,
  316558,316564,316568,316569,316577,316578,316580,316586,316587,316588,
  316589,316590,316591,316592,316594,316597,316599,316601,316603,316604,
  316605,316606,316610,316611,316612,316614,316616,316626,316629,316630,
  316631,316633,316634,316635,316636,316637,316640,316657,316659,316661,
  316662,316663,316666,316667,316669,316671,316672,316673,316675,316676,
  316677,316678,316680,316681,316682,316685,316686,316687,316688,316689,
  316691,316692,316693,316694,316695,316697,316701,316702,316703,316704,
  316708,316711,316712,316714,316720,316721,316722,316723,316724,316725,
  316726,316727,316728,316732,316733,316734,316735,316740,316741,316742,
  316743,316746,316756,316757,316758,316760,316762,316763,316766,316767,
  316768,316769,316770,316771,316772,316773,316774,316775,316776,316777,
  316779,316780,316782,316783,316784,316790,316791,316792,316794,316795,
  316798,316800,316801,316806,316807,316808,316809,316811,316815,316816,
  316817,316830,316831,316834,316841,316844,316845,316847,316850,316851,
  316856,316866,316868,316870,316875,316877,316878,316889,316891,316893,
  316894,316897,316901,316903,316904,316905,316906,316907,316908,316914,
  316925,316926,316929,316931,316932,316939,316940,316941,316944,316946,
  316947,316948,316957,316958,316959,316960,316961,316962,316965,316967,
  316969,316972,316974,316975,316978,316979,316980,316981,316982,316983,
  316985,316987,316989,316990,316991,316992,316995,316997,316998,317001,
  317013,317015,317016,317017,317018,317019,317020,317021,317031,317032,
  317034,317038,317045,317046,317047,317050,317051,317055,317056,317065,
  317072,317075,317076,317077,317084,317089,317091,317097,317109,317113,
  317118,317123,317134,317135,317136,317138,317139,317140,317141,317142,
  317145,317146,317148,317153,317156,317157,317161,317164,317172,317173,
  317175,317176,317177,317178,317179,317187,317190,317191,317195,317201,
  317206,317207,317211,317213,317215,317218,317220,317232,317236,317237,
  317238,317239,317242,317247,317248,317251,317252,317254,317255,317257,
  317258,317261,317262,317265,317268,317269,317270,317271,317273,317275,
  317276,317281,317282,317284,317289,317290,317292,317293,317294,317297,
  317302,317304,317307,317308,317316,317317,317322,317323,317325,317326,
  317329,317333,317336,317341,317342,317343,317344,317345,317349,317350,
  317351,317353,317355,317360,317363,317365,317366,317367,317368,317369,
  317371,317372,317373,317374,317382,317386,317388,317393,317394,317395,
  317396,317401,317405,317406,317407,317410,317411,317413,317414,317415,
  317416,317417,317422,317423,317424,317426,317427,317428,317429,317430,
  317432,317433,317434,317435,317436,317437,317438,317439,317440,317441,
  317445,317446,317447,317450,317451,317452,317453,317454,317455,317456,
  317457,317459,317460,317461,317462,317463,317468,317469,317473,317474,
  317475,317476,317478,317479,317482,317483,317487,317488,317490,317491,
  317496,317499,317500,317501,317504,317509,317510,317511,317512,317513,
  317514,317515,317516,317519,317521,317522,317523,317525,317530,317538,
  317548,317549,317550,317552,317557,317558,317559,317560,317561,317562,
  317564,317565,317566,317567,317568,317570,317571,317572,317575,317576,
  317577,317578,317581,317583,317586,317587,317588,317589,317590,317591,
  317592,317593,317596,317599,317600,317601,317602,317603,317604,317605,
  317606,317607,317609,317610,317612,317615,317617,317620,317621,317623,
  317627,317628,317630,317631,317633,317635,317636,317637,317638,317639,
  317640,317652,317653,317659,317660,317665,317666,317668,317669,317672,
  317673,317674,317675,317676,317677,317679,317680,317685,317687,317690,
  317692,317693,317694,317696,317697,317699,317700,317701,317703,317705,
  317706,317708,317709,317710,317711,317712,317713,317716,317717,317718,
  317725,317729,317731,317732,317733,317734,317735,317736,317737,317739,
  317741,317742,317743,317744,317745,317746,317751,317754,317755,317757,
  317758,317759,317760,317761,317762,317763,317765,317766,317767,317768,
  317769,317771,317774,317775,317777,317787,317789,317790,317791,317792,
  317794,317796,317797,317800,317804,317807,317808,317809,317814,317817,
  317818,317820,317822,317824,317826,317828,317829,317832,317833,317827,
  317834,317835,317836,317838,317839,317844,317853,317854,317857,317858,
  317859,317861,317864,317867,317868,317869,317872,317873,317875,317876,
  317877,317881,317882,317884,317886,317889,317896,317898,317899,317902,
  317904,317907,317909,317910,317911,317913,317915,317916,317919,317920,
  317925,317933,317935,317939,317940,317942,317949,317951,317952,317953,
  317957,317959,317961,317962,317965,317967,317968,317970,317972,317973,
  316485,317974,317975,317976,317977,317979,317980,317981,317982,317983,
  317984,317985,317987,317988,317989,317990,317991,317993,317995,317996,
  317998,317999,318000,318001,318002,318004,318006,318007,318008,318010,
  318013,318014,318016,317009,
]);

async function main(): Promise<void> {
  console.log(`CRM subscription IDs: ${CRM_IDS.size} unique`);

  // Get ALL subscriptions in date range (with tag info)
  const ourSubs = await q<{ id: number; tag: string | null }>(
    `SELECT s.id, s.tag FROM subscription s WHERE s.date_create BETWEEN ? AND ?`,
    [S, E],
  );

  const allSubIds = new Set(ourSubs.map((r) => r.id));
  const upsellTagged = ourSubs.filter((r) => r.tag && String(r.tag).includes('parent-sub-id='));
  const upsellIds = new Set(upsellTagged.map((r) => r.id));
  const nonUpsellIds = new Set(
    ourSubs.filter((r) => !r.tag || !String(r.tag).includes('parent-sub-id=')).map((r) => r.id),
  );

  console.log(`\nDB subscriptions in date range: ${allSubIds.size}`);
  console.log(`  Tagged as upsell (parent-sub-id): ${upsellIds.size}`);
  console.log(`  Non-upsell (dashboard Q1): ${nonUpsellIds.size}`);

  // --- CRM vs ALL DB subs ---
  const inCrmNotInDb = [...CRM_IDS].filter((id) => !allSubIds.has(id));
  const inDbNotInCrm = [...allSubIds].filter((id) => !CRM_IDS.has(id));

  console.log(`\n--- CRM vs ALL DB subs ---`);
  console.log(`In CRM but NOT in DB: ${inCrmNotInDb.length}`);
  if (inCrmNotInDb.length > 0 && inCrmNotInDb.length <= 30) {
    console.log(`  IDs: ${inCrmNotInDb.join(', ')}`);
  }
  console.log(`In DB but NOT in CRM: ${inDbNotInCrm.length}`);
  if (inDbNotInCrm.length > 0 && inDbNotInCrm.length <= 30) {
    console.log(`  IDs: ${inDbNotInCrm.join(', ')}`);
  }

  // --- CRM vs dashboard (non-upsell) ---
  const inCrmNotInDash = [...CRM_IDS].filter((id) => !nonUpsellIds.has(id));
  const missingBecauseUpsell = inCrmNotInDash.filter((id) => upsellIds.has(id));
  const missingNotInDb = inCrmNotInDash.filter((id) => !allSubIds.has(id));
  const missingOther = inCrmNotInDash.filter((id) => allSubIds.has(id) && !upsellIds.has(id));

  console.log(`\n--- CRM vs DASHBOARD (non-upsell) ---`);
  console.log(`In CRM but NOT in dashboard: ${inCrmNotInDash.length}`);
  console.log(`  Reason: tagged as upsell: ${missingBecauseUpsell.length}`);
  console.log(`  Reason: not in DB at all: ${missingNotInDb.length}`);
  console.log(`  Reason: other (in DB, not upsell): ${missingOther.length}`);

  // Sample some upsell-tagged ones to verify
  if (missingBecauseUpsell.length > 0) {
    const sampleIds = missingBecauseUpsell.slice(0, 5);
    const details = await q<{ id: number; tag: string; date_create: string }>(
      `SELECT s.id, s.tag, s.date_create FROM subscription s WHERE s.id IN (${sampleIds.map(() => '?').join(',')})`,
      sampleIds,
    );
    console.log(`\n  Sample upsell-tagged subs:`);
    for (const d of details) {
      console.log(`    ${d.id}: tag="${d.tag}" date=${String(d.date_create)}`);
    }
  }

  // Summary
  console.log(`\n=== SUMMARY ===`);
  console.log(`CRM: ${CRM_IDS.size} | Dashboard: ${nonUpsellIds.size} | Diff: ${CRM_IDS.size - nonUpsellIds.size}`);
  console.log(`Upsell-tagged explains: ${missingBecauseUpsell.length}`);
  console.log(`Match: CRM (${CRM_IDS.size}) = Dashboard (${nonUpsellIds.size}) + Upsell-tagged (${missingBecauseUpsell.length}) + other (${missingNotInDb.length + missingOther.length})`);

  await pool.end();
}

main().catch((err) => {
  console.error(err);
  process.exit(1);
});
